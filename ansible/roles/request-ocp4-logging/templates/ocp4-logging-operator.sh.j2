#!/bin/bash

echo "Starting elasticsearch operator"
oc create -f {{ logging_bastion_setup_dir }}/elasticsearch-operator.yaml
sleep_count=15
while [[ $sleep_count -gt 0 ]]; do
  subs_status=$(oc  get subs --all-namespaces | grep  -e  elasticsearch | tr -s ' ')
  if [[ -z $subs_status ]] ; then
    echo "Waiting for Subscription to elasticsearch"
    sleep 1m
    ((sleep_count--))
  else
    echo "elasticsearch subscription available"
    break
  fi
done
minor_version=$(oc version | grep Server | rev | cut -f1 -d' '| cut -f1 -d'.' --complement | rev | cut -f2 -d'.')
if [[ $minor_version -lt 4 ]]; then
  echo 'Doing rbac for ocp versions 4.3'
  oc create -f {{ logging_bastion_setup_dir }}/logging-rbac.yaml
fi
echo "Starting cluster-logging operator "
oc create -f {{ logging_bastion_setup_dir }}/logging-operator.yaml
sleep_count=15
while [[ $sleep_count -gt 0 ]]; do
  subs_status=$(oc  get subs --all-namespaces | grep  -e  cluster-logging | tr -s ' ')
  if [[ -z $subs_status ]] ; then
    echo "Waiting for Subscription to cluster-logging"
    sleep 1m
    ((sleep_count--))
  else
    echo "cluster-logging subscription available"
    break
  fi
done
